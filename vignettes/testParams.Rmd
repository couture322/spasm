---
title: 'Testing params: sim_fishery vs sim_fisheryAq'
author: "Jessica Couture"
date: "August 19, 2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE, warning = FALSE,
                      fig.height = 9)
```

Testing the impacts of MPA vs farm (compared to no MPA) under constant effort and open access fishery management. The species used here will be a pollock species: Saithe ([*P. virens*](https://www.fishbase.se/summary/Pollachius-virens.html)), which is highly mobile and has commonly been found at high abundances around farms. Most of the biological data I am pulling from fishbase, but movement has been updated to be 5 for adults and juveniles.   
  
Additionally, distribution and design of farms compared to MPAs is different. Here I simulate one large MPA compared to several separate farms (farm size defined by the *farmSize* parameter in the `sim_fisheryAq` function). Below this I also test the impacts of these orientations on the results, impact of buffer size, and add in *mpa_habfactor* in the final plots.

Common parameters include:

* MPA implemented in year 50
* Initial effort = 10,000
* Test species: *Pollachius virens*, aka. Saithe
* Total patches = 100, movement = 5


```{r commonParams}

library(spasm)
library(FishLife)
library(spasm)
library(ggridges)
library(gganimate)
library(tidyverse)
library(cowplot)

fishPv <-
  create_fish(
  scientific_name = "Pollachius virens",
  query_fishlife = T,
  mat_mode = "length",
  time_step = 1,
  # sigma_r = 0,
  # steepness = 0.9,
  # r0 = 4290000,
  # rec_ac = 0,
  adult_movement = 5,
  larval_movement = 5,
  density_dependence_form = 2 # change to 2 to use the habfactor
  )
          
fishPv$common_name<-"Saithe"

head(fishPv)

```

## "Good" management  

Constant Effort, effort concentrates when MPA takes effect initial fishing effort is high


```{r constEff, echo=TRUE}


fleetCE <- create_fleet(
  fish = fishPv,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.1 * fishPv$linf,
  initial_effort = 10000,
  profit_lags =  5,
  beta = 2,
  max_cr_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'simple',
  mpa_reaction = "concentrate"
)

```



```{r}

### No MPA

ceNull <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetCE,
  manager = create_manager(mpa_size = 0, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 1,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="noMPA")

#plot_spasm(ceNull, type = "totals", font_size = 12)

```



```{r}
### Standard MPA
ceMPA <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetCE,
  manager = create_manager(mpa_size = 0.2, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 1,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="mpa")

#plot_spasm(ceMPA, type = "totals", font_size = 12)

```


```{r}
## Aquaculture
ceAq <- sim_fisheryAq(
  fish = fishPv,
  fleet = fleetCE,
  manager = create_manager(mpa_size = 0.2, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 1,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE,
  bufferMove = 100,
  farmSize = 2,
  farmStay = 100) %>%
  mutate(run="farm")

#plot_spasm(ceAq, type = "totals", font_size = 12)


```

```{r ceAll}

ceAll<-bind_rows(ceNull,ceMPA,ceAq)%>%
  group_by(year,run)%>%
  summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
  ungroup()%>%
  mutate(PPUE=profits/effort) %>%
  filter(!year<50)

ceBM<-ggplot(ceAll,aes(year,biomass,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()

ceCatch<-ggplot(ceAll,aes(year,catch,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()

cePPUE<-ggplot(ceAll,aes(year,PPUE,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(ceBM,ceCatch,cePPUE,ncol=1)

```


***

## "Bad" management  

Open access, *leave* when MPA takes effect


```{r openAccess, echo=TRUE}


fleetOA <- create_fleet(
  fish = fishPv,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "open-access",#"constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.1 * fishPv$linf,
  initial_effort = 10000,
  profit_lags =  5,
  beta = 2,
  max_cr_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'simple',
  mpa_reaction = "leave"
)

```



```{r}
### No MPA
oaNull <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0, year_mpa = 50),
  num_patches = 100,
  sim_years = 75,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="noMPA")

#plot_spasm(oaNull, type = "totals", font_size = 12)

### looking at the data

oaNtot<-oaNull %>%
  group_by(year)%>%
  mutate(effort=sum(effort),
          profits=sum(profits),
          biomass=sum(biomass),
          catch=sum(numbers_caught)) %>%
  ungroup()%>%
  mutate(PPUE=profits/effort)

ggplot(oaNtot,aes(year,effort))+
  geom_line()+
  theme_bw()

```



```{r}
### Standard MPA
oaMPA <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0.2, year_mpa = 50),
  num_patches = 100,
  sim_years = 75,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="mpa")

#plot_spasm(oaMPA, type = "totals", font_size = 12)

```



```{r}
## Aquaculture
oaAq <- sim_fisheryAq(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0.2, year_mpa = 50),
  num_patches = 100,
  sim_years = 75,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE,
  bufferMove = 100,
  farmSize = 2,
  farmStay = 100) %>%
  mutate(run="farm")

#plot_spasm(oaAq, type = "totals", font_size = 12)


```

```{r oaAll}

oaAll<-bind_rows(oaNull,oaMPA,oaAq)%>%
  group_by(year,run)%>%
  summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
  ungroup()%>%
  mutate(PPUE=profits/effort) %>%
  filter(year>50)

oaBM<-ggplot(oaAll,aes(year,biomass,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()

oaCatch<-ggplot(oaAll,aes(year,effort,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()

oaPPUE<-ggplot(oaAll,aes(year,PPUE,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(oaBM,oaCatch,oaPPUE,ncol=1)

```

***

## Testing orientation of protected spaces

```{r}

frmSzs<-c(0,1,3,5)

```

One large farm versus multiple smaller farms of different sizes. For farms, how does the farm size change the results?  
Testing: `farmSize` = `r frmSzs`  
**a farm size = 0 indicates no dividing up, so there will be one large farm*

```{r}

shape<-data.frame(year=numeric(), 
                  farmSize=numeric(),
                  biomass=numeric(),
                  catch=numeric(),
                  PPUE=numeric())


for(i in 1:length(frmSzs)) {
  
  df <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA, ### OPEN ACCESS
    manager = create_manager(mpa_size = 0.2, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 1,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    bufferMove = 100,
    farmSize = frmSzs[i], #####
    farmStay = 100) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(PPUE=profits/effort,
           farmSize=frmSzs[i]) %>%
    select(year, farmSize, biomass, catch, PPUE)
  
  shape<-bind_rows(shape,df)


}


shape<-shape %>%
  #select(-farmSize)%>%
  mutate(type="farm") %>%
  bind_rows(.,oaAll%>%
              mutate(farmSize=0)%>%
              filter(run=="mpa") %>%
              rename(type=run) %>%
              select(year,farmSize, biomass, catch,PPUE,type))

shpBM<-ggplot(shape[shape$year>50,],aes(year,biomass,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpCatch<-ggplot(shape[shape$year>50,],aes(year,catch,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpPPUE<-ggplot(shape[shape$year>50,],aes(year,PPUE,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpTtl<-ggdraw()+draw_label("Open access")

plot_grid(shpTtl,shpBM,shpCatch,shpPPUE,ncol=1,rel_heights = c(0.15,1,1,1))
```

```{r}

shapeCE<-data.frame(year=numeric(), 
                  farmSize=numeric(),
                  biomass=numeric(),
                  catch=numeric(),
                  PPUE=numeric())


for(i in 1:length(frmSzs)) {
  
  df <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetCE, ### CONSTANT EFFORT
    manager = create_manager(mpa_size = 0.2, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 1,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    bufferMove = 100,
    farmSize = frmSzs[i], #####
    farmStay = 100) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(PPUE=profits/effort,
           farmSize=frmSzs[i]) %>%
    select(year, farmSize, biomass, catch, PPUE)
  
  shapeCE<-bind_rows(shapeCE,df)


}

shapeCE<-shapeCE %>%
  #select(-farmSize)%>%
  mutate(type="farm") %>%
  bind_rows(.,ceAll%>%
              mutate(farmSize=0)%>%
              filter(run=="mpa") %>%
              rename(type=run) %>%
              select(year,farmSize, biomass, catch,PPUE,type))


shpBMCE<-ggplot(shapeCE[shapeCE$year>50,],aes(year,biomass,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpCatchCE<-ggplot(shapeCE[shapeCE$year>50,],aes(year,catch,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpPPUECE<-ggplot(shapeCE[shapeCE$year>50,],aes(year,PPUE,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpTtlCE<-ggdraw()+draw_label("Constant Effort")

plot_grid(shpTtlCE,shpBMCE,shpCatchCE,shpPPUECE,ncol=1,rel_heights = c(0.15,1,1,1))

```


***

## Testing size of buffer around farm

```{r}
buffers<-c(0,10,50,100,200)
```

Here I am varying the size of the buffer around the farm (`r buffers`) and plotting the results with just MPA as well (from data above)

```{r}

fishBuff <-
  create_fish(
  scientific_name = "Pollachius virens",
  query_fishlife = T,
  mat_mode = "length",
  time_step = 1,
  # sigma_r = 0,
  # steepness = 0.9,
  # r0 = 4290000,
  # rec_ac = 0,
  adult_movement = 20,
  larval_movement = 20,
  density_dependence_form = 2 # change to 2 to use the habfactor
  )

fleetOAbuff <- create_fleet(
  fish = fishBuff,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "open access",
  sigma_effort = 0,
  length_50_sel = 0.1 * fishBuff$linf,
  initial_effort = 10000,
  profit_lags =  5,
  beta = 2,
  max_cr_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'simple',
  mpa_reaction = "leave"
)

buff<-data.frame(year=numeric(),
                 buffSz=numeric(),
                 biomass=numeric(),
                 catch=numeric(),
                 PPUE=numeric())


for(i in 1:length(buffers)) {
  
  dfB <- sim_fisheryAq(
    fish = fishBuff,
    fleet = fleetOAbuff, ### OPEN ACCESS
    manager = create_manager(mpa_size = 0.2, year_mpa = 50),
    num_patches = 1000,
    sim_years = 100,
    burn_years = 1,
    time_step = fishBuff$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    bufferMove = 100,
    buffSize = buffers[i],
    farmSize = 10,
    farmStay = 100) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(PPUE=profits/effort,
           buffSz=buffers[i]) %>%
    select(year, buffSz, biomass, catch, PPUE)
  
  buff<-bind_rows(buff,dfB)


}


bffBM<-ggplot(buff[buff$year>50,],aes(year,biomass,color=as.factor(buffSz),group=as.factor(buffSz)))+
  geom_line()+
  labs()+
  theme_bw()

bffCatch<-ggplot(buff[buff$year>50,],aes(year,catch,color=as.factor(buffSz),group=as.factor(buffSz)))+
  geom_line()+
  labs()+
  theme_bw()

bffPPUE<-ggplot(buff[buff$year>50,],aes(year,PPUE,color=as.factor(buffSz),group=as.factor(buffSz)))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(shpTtl,bffBM,bffCatch,bffPPUE,ncol=1,rel_heights = c(0.15,1,1,1))
```

***

## Testing impacts of mpa_habfactor

```{r}
farmHF<-c(1,3,5,10,20)

```

*mpa_habfactor* was built into SPASM to adjust the habitat quality within the MPA, compared to outside. I added code to turn the habitat quality on when a farm is installed. I can also add an additional habitat quality (during fallowing) but am not parameterizing for that here.

*farmStay* is held constant at 100 for each run, *habfactor* is varied (`r farmHF`). *farmSize* is also held constant as one large farm (20%)

```{r}

hfDf<-data.frame(year=numeric(),
                 habFactor=numeric(),
                 biomass=numeric(), 
                 catch=numeric(),
                 PPUE=numeric())

for(i in 1:length(farmHF)){
  
  dfHf <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA,
    manager = create_manager(mpa_size = 0.2, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 1,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = farmHF[i],
    sprinkler = FALSE,
    keep_burn = FALSE,
    bufferMove = 100,
    farmSize = 0, ### one big farm like mpas, habFac = 1 should be the same as mpa
    farmStay = 100,
    farm_yrs = c(50:100)) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(PPUE=profits/effort,
           habFactor=farmHF[i]) %>%
    select(year, habFactor,biomass, catch, PPUE)

  hfDf<-bind_rows(hfDf,dfHf)  
  
}

habFac<-hfDf %>%
  filter(year>50)%>%
  mutate(type="farm") %>%
  bind_rows(.,oaAll%>%
              filter(run=="mpa") %>%
              rename(type=run) %>%
              #mutate(habFactor==1)%>%
              select(year, biomass, catch,PPUE,type))
habFac[is.na(habFac$habFactor),"habFactor"]<-1


hfBM<-ggplot(habFac,aes(year,biomass,color=as.factor(habFactor),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

hfCatch<-ggplot(habFac,aes(year,catch,color=as.factor(habFactor),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

hfPPUE<-ggplot(habFac,aes(year,PPUE,color=as.factor(habFactor),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(shpTtl,hfBM,hfCatch,hfPPUE,ncol=1,rel_heights = c(0.15,1,1,1))
```

####Small farms

`farSize = 3`

```{r}

hfsDf<-data.frame(year=numeric(),
                 habFactor=numeric(),
                 biomass=numeric(), 
                 catch=numeric(),
                 PPUE=numeric())

for(i in 1:length(farmHF)){
  
  dfHfs <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA,
    manager = create_manager(mpa_size = 0.2, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 1,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = farmHF[i],
    sprinkler = FALSE,
    keep_burn = FALSE,
    bufferMove = 100,
    farmSize = 3, ### farms are small should be more different than above
    farmStay = 100,
    farm_yrs = c(50:100)) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(PPUE=profits/effort,
           habFactor=farmHF[i]) %>%
    select(year, habFactor,biomass, catch, PPUE)

  hfsDf<-bind_rows(hfsDf,dfHfs)  
  
}

habFacS<-hfsDf %>%
  filter(year>50)%>%
  mutate(type="farm") %>%
  bind_rows(.,oaAll%>%
              filter(run=="mpa") %>%
              rename(type=run) %>%
              #mutate(habFactor==1)%>%
              select(year, biomass, catch,PPUE,type))
habFacS[is.na(habFacS$habFactor),"habFactor"]<-1


hfBMs<-ggplot(habFacS,aes(year,biomass,color=as.factor(habFactor),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

hfCatchS<-ggplot(habFacS,aes(year,catch,color=as.factor(habFactor),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

hfPPUEs<-ggplot(habFacS,aes(year,PPUE,color=as.factor(habFactor),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(shpTtl,hfBMs,hfCatchS,hfPPUEs,ncol=1,rel_heights = c(0.15,1,1,1))
```


***

# messing with farmStay

```{r farmStayMess}

stayTest <- sim_fisheryAq(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0.2, year_mpa = 25),
  num_patches = 100,
  sim_years = 100,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  farmStay = 100, ##
  farmSize=5,
  sprinkler = FALSE,
  keep_burn = FALSE
)

stayTest %>% 
  filter(year == max(year),
         mpa == TRUE) %>% 
  group_by(patch) 

plot_spasm(stayTest, type = "totals", font_size = 12)

stayTest%>% 
  filter(year == max(year)) %>% 
  group_by(patch) %>% 
  summarise(biomass = sum(biomass),
            mpa = unique(mpa)) %>% 
  ggplot(aes(patch, biomass, fill = mpa)) + 
  geom_col()

```

```{r simFishTests}

test<-sim_fisheryAq(fish=fishPv,
              fleet=fleetOA,
              manager=create_manager(mpa_size = 0.2, year_mpa = 3),
              num_patches = 20,
              sim_years = 10,
              burn_years = 1,
              crashed_pop = 1e-3,
              random_mpas = F,
              farmSize=2, # to set regular MPA/farms of a specific size (value is numer of patches, will be distributed evenly along the total area)
              enviro = NA,
              enviro_strength = 1,
              rec_driver = "stochastic",
              est_msy = F,
              time_step,
              max_window = 10,
              min_size = 1,
              mpa_habfactor = 1,
              farm_yrs = NA,
              #fallowFactor = 1,
              farmAttr=1.5,#value of 1 does nothing, higher increases movement to farm
              #farmStay = 0.9,
              #bufferMove=1,
              buffSize=3,
              sprinkler = FALSE,
              keep_burn = FALSE,
              tune_costs = FALSE)

# frmSty<-data.frame(to=c(1:20),
#                    frmImp=c(rep(20,4),rep(1,16)))
# 
# test2<-test%>%
#   left_join(.,frmSty)%>%
#   mutate(pm2=prob_move*frmImp)
# 
# ggplot(test2,aes(distance,pm2,color=frmImp),shape=23)+
#   geom_jitter()
# 
# ggplot(test,aes(distance, prob_move,color=farmImpacts))+
#   geom_jitter()
#   

test%>% 
  filter(year == 5) %>% 
  group_by(patch) %>% 
  summarise(biomass = sum(biomass),
            mpa = unique(mpa)) %>% 
  ggplot(aes(patch, biomass, fill = mpa)) + 
  geom_col()

```
