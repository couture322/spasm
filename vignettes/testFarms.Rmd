---
title: "Testing farm additions"
author: "Jessica Couture"
date: "July 26, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)
```

## Adult movement impacts

I adjusted the adult_move_grid code in 'sim_fisheryAq.R' to include a multiplier from a new argument in sim_fisheryAq: *"farmStay"*. The default for *farmStay* is NA, but will take a value that will be a divisor for the movement probabilities. The code takes the calculated probability of movement that Dan wrote and divides those cells with the farm by the *farmStay* value. Ren used 2x biomass for his FADs analysis, so will try 2 and 4 to see the impacts.

#### Original from 'spasm.Rmd'

These tests are under the following scenarios:  
Adult movement = 5
Larval movement = 5
Density independent recruitment (density_dependence_form = 1) *to use farm_habfactor need to use ddf=2*
fishing = open access --> test how this changes with "constant effort" (doesn't change much, why?)



```{r fullSimfishcompareSM}

library(tidyverse)
library(FishLife)
library(spasm)
library(ggridges)
library(gganimate)


fish <-
  create_fish(
    scientific_name = "Atractoscion nobilis",
    query_fishlife = T,
    mat_mode = "length",
    time_step = 1,
    sigma_r = 0,
    steepness = 0.9,
    r0 = 4290000,
    rec_ac = 0,
    adult_movement = 10,
    larval_movement = 5,
    density_dependence_form = 1
  )


fleet <- create_fleet(
  fish = fish,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.1 * fish$linf,
  initial_effort = 2000,
  profit_lags =  5,
  beta = 2,
  max_cr_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'simple',
  mpa_reaction = "leave"
)


simpleS <- spasm::sim_fishery(
  fish = fish,
  fleet = fleet,
  manager = create_manager(mpa_size = 0.1, year_mpa = 15),
  num_patches = 100,
  sim_years = 50,
  burn_years = 1,
  time_step = fish$time_step,
  est_msy = FALSE,
  random_mpas = TRUE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)

simpleS %>% 
  filter(year == max(year),
         mpa == TRUE) %>% 
  group_by(patch) 

plot_spasm(simpleS, type = "totals", font_size = 12)

simpleS%>%
  group_by(year)%>%
  mutate(catch=sum(biomass_caught))%>%
  ggplot(aes(year,catch))+
  geom_line()

```

#### Test of *farmStay*

```{r fullSimfishcompareSMt}

simpleSTest <- sim_fisheryAq(
  fish = fish,
  fleet = fleet,
  manager = create_manager(mpa_size = 0.1, year_mpa = 15),
  num_patches = 100,
  sim_years = 50,
  burn_years = 1,
  time_step = fish$time_step,
  est_msy = FALSE,
  random_mpas = TRUE,
  min_size = 0.05,
  mpa_habfactor = 1,
  farmStay = 3, ##
  sprinkler = FALSE,
  keep_burn = FALSE
)

simpleSTest %>% 
  filter(year == max(year),
         mpa == TRUE) %>% 
  group_by(patch) 

plot_spasm(simpleSTest, type = "totals", font_size = 12)

simpleSTest%>% 
  filter(year == max(year)) %>% 
  group_by(patch) %>% 
  summarise(biomass = sum(biomass),
            mpa = unique(mpa)) %>% 
  ggplot(aes(patch, biomass, fill = mpa)) + 
  geom_col()

```

#### simple: large

```{r fullSimfishcompareLG}
simpleL <- spasm::sim_fishery(
  fish = fish,
  fleet = fleet,
  manager = create_manager(mpa_size = 0.4, year_mpa = 15),
  num_patches = 100,
  sim_years = 50,
  burn_years = 1,
  time_step = fish$time_step,
  est_msy = FALSE,
  random_mpas = TRUE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)

simpleL %>% 
  filter(year == max(year),
         mpa == TRUE) %>% 
  group_by(patch) 

plot_spasm(simpleL, type = "totals", font_size = 12)

simpleL %>% 
  filter(year == max(year)) %>% 
  group_by(patch) %>% 
  summarise(biomass = sum(biomass),
            mpa = unique(mpa)) %>% 
  ggplot(aes(patch, biomass, fill = mpa)) + 
  geom_col()

```

#### Test of *farmStay*: large

```{r fullSimfishcompareLGt}

simpleLTest <- sim_fisheryAq(
  fish = fish,
  fleet = fleet,
  manager = create_manager(mpa_size = 0.4, year_mpa = 15),
  num_patches = 100,
  sim_years = 50,
  burn_years = 1,
  time_step = fish$time_step,
  est_msy = FALSE,
  random_mpas = TRUE,
  min_size = 0.05,
  mpa_habfactor = 1,
  farmStay = 3, ##
  sprinkler = FALSE,
  keep_burn = FALSE
)

simpleLTest %>% 
  filter(year == max(year),
         mpa == TRUE) %>% 
  group_by(patch) 

plot_spasm(simpleLTest, type = "totals", font_size = 12)

simpleLTest%>% 
  filter(year == max(year)) %>% 
  group_by(patch) %>% 
  summarise(biomass = sum(biomass),
            mpa = unique(mpa)) %>% 
  ggplot(aes(patch, biomass, fill = mpa)) + 
  geom_col()

```

### Profits per unit Effort in year 50 compared

```{r}
smallMPA_PPUE50<-simpleS%>%
  group_by(year) %>% 
  summarise(Effort = sum(effort), 
            Profits = sum(profits), Biomass = sum(biomass)) %>% 
            ungroup() %>% 
  mutate(`Profit Per Unit Effort` = Profits/Effort)%>%
  filter(year==50)%>%
  mutate(scenario="MPA_small")%>%
  select(scenario,`Profit Per Unit Effort`)


smallFarm_PPUE50<-simpleSTest%>%
  group_by(year) %>% 
  summarise(Effort = sum(effort), 
            Profits = sum(profits), Biomass = sum(biomass)) %>% 
            ungroup() %>% 
  mutate(`Profit Per Unit Effort` = Profits/Effort)%>%
  filter(year==50)%>%
  mutate(scenario="farm_small")%>%
  select(scenario,`Profit Per Unit Effort`)


largMPA_PPUE50<-simpleL%>%
  group_by(year) %>% 
  summarise(Effort = sum(effort), 
            Profits = sum(profits), Biomass = sum(biomass)) %>% 
            ungroup() %>% 
  mutate(`Profit Per Unit Effort` = Profits/Effort)%>%
  filter(year==50)%>%
  mutate(scenario="MPA_big")%>%
  select(scenario,`Profit Per Unit Effort`)

PPUEs50<-simpleLTest%>%
  group_by(year) %>% 
  summarise(Effort = sum(effort), 
            Profits = sum(profits), Biomass = sum(biomass)) %>% 
            ungroup() %>% 
  mutate(`Profit Per Unit Effort` = Profits/Effort)%>%
  filter(year==50)%>%
  mutate(scenario="farm_big")%>%
  select(scenario,`Profit Per Unit Effort`)%>%
  bind_rows(smallMPA_PPUE50,smallFarm_PPUE50,largMPA_PPUE50,.)

PPUEs50

```

### varying far size and species mobility

```{r}


          fishP <-
            create_fish(
            scientific_name = "Pollachius virens",
            query_fishlife = T,
            mat_mode = "length",
            time_step = 1,
            sigma_r = 0,
            steepness = 0.9,
            r0 = 4290000,
            rec_ac = 0,
            adult_movement = 7,
            larval_movement = 5,
            density_dependence_form = 2 # change to 2 to use the habfactor
            )
          
          fleetP <- create_fleet(
            fish = fishP,
            cost_cv =  0,
            cost_ac = 0,
            cost_slope = 0,
            q_cv = 0,
            q_ac = .7,
            q_slope = 0,
            fleet_model = "constant-effort",
            sigma_effort = 0,
            length_50_sel = 0.1 * fishP$linf,
            initial_effort = 2000,
            profit_lags =  5,
            beta = 2,
            max_cr_ratio = 0.9,
            max_perc_change_f = 0.5,
            effort_allocation = 'simple',
            mpa_reaction = "concentrate" # changed this from "leave" to "concentrate"
            )

rangesFunc<-function(fish,fleet,szVec,fsVec,farmHabFact){

  df<-data.frame(year=numeric(),
                 size=numeric(),
                 farmStay=numeric(),
                 habFact=numeric(),
                 ppue=numeric())
  
  
    for(j in 1:length(szVec)){

      for(k in 1:length(fsVec)){
        
        for(l in 1:length(farmHabFact)){

        tempDf<-sim_fisheryAq(
          fish = fish,
          fleet = fleet,
          manager = create_manager(mpa_size = szVec[j], year_mpa = 15),
          num_patches = 100,
          sim_years = 50,
          burn_years = 1,
          time_step = fish$time_step,
          est_msy = FALSE,
          random_mpas = FALSE, # hoping to simplify with FALSE
          min_size = 0.05,
          mpa_habfactor = farmHabFact[l],
          farmStay = fsVec[k],
          sprinkler = FALSE,
          keep_burn = FALSE)%>%
          group_by(year) %>%
          summarise(Effort = sum(effort),
                    Profits = sum(profits),
                    catch=sum(numbers_caught))%>%
          ungroup() %>%
          mutate(ppue = Profits/Effort)%>%
          #filter(year==max(year))%>%
          mutate(size=szVec[j],
                 farmStay=fsVec[k],
                 habFact=farmHabFact[l])%>%
          select(year,size,farmStay,habFact,catch,ppue)


      df<-df%>%
        bind_rows(.,tempDf)
        }
      
      }
      rm(tempDf)
  }
  return(df)
}
  
```

```{r}

## test data
#moveVecT<-c(0,10)
# sizeVecT<-c(0,0.5)
# farmVecT<-c(1,10)
# habVecT<-c(1,4)
# msDfT<-rangesFunc(fishP,fleetP,sizeVecT,farmVecT,habVecT)#test:
# head(msDfT)


### Full runs

#moveVec<-seq(0,10,by=1)
sizeVec<-seq(0,0.7,by=0.1)

## inputs to farmStay:
## first tried: seq(1,10,by=1) --> not much impact, trying wider range of values
## 2nd try: seq(1,100,by=10)
## 3rd try: changed from divisor to multiplier so will test 1-10 again

farmVec<-seq(1,10,by=1)

habVec<-seq(1,4,by=1) # not using farm hab-factor, just mpa_habfactor, test this next

# hours to run # 
sfhy<-rangesFunc(fishP,fleetP,sizeVec,farmVec,habVec)#test: rangesFunc(c(0,5),c(0,0.5),c(1,2),c(1,2))
#head(msDf)

#write.csv(sfhy,file="testRunSFHY2.csv",row.names = F)
```

```{r}

#msDf<-read_csv("testRunMSFH.csv")

mvSzMPA<-msDfT %>%
  filter(farmStay==1) %>%
  filter(habFact==1)

rangePlot<-ggplot(mvSzMPA,aes(move,ppue,color=size,group=size))+
  geom_point()+
  geom_line()+
  theme_bw()+
  labs(title = "Standard MPA",
       x="Adult movement parameter\n(relative to total area)",
       y="Profit per unit effort")


rangePlot

```

```{r}

mvFS<-msDfT %>%
  filter(size==0.5)%>%
  filter(habFact==1)

mvFSPlot<-ggplot(mvFS,aes(move,ppue,color=farmStay,group=farmStay))+
  geom_point()+
  geom_line()+
  theme_bw()+
  labs(title = "Effect of dulling adult movement parameter (farmStay)",
       x="Adult movement parameter\n(relative to total area)",
       y="Profit per unit effort")


mvFSPlot

```

```{r}

szFS<-msDfT %>%
  filter(habFact==1)

szFSPlot<-ggplot(szFS,aes(size,ppue,color=farmStay,group=farmStay))+
  geom_point()+
  geom_line()+
  theme_bw()+
  labs(title = "Effect of dulling adult movement parameter (farmStay)",
       subtitle = "movement=5",
       x="Farm size (% of total area)",
       y="Profit per unit effort")


szFSPlot

```

```{r}

mvHF<-msDfT %>%
  filter(size==0.5)%>%
  filter(farmStay==1)

mvHFPlot<-ggplot(mvHF,aes(move,ppue,color=habFact,group=habFact))+
  geom_point()+
  geom_line()+
  theme_bw()+
  labs(title = "Effect of recruitment parameter (habfactor)",
       x="Adult movement parameter\n(relative to total area)",
       y="Profit per unit effort")


mvHFPlot

```

```{r}

szHF<-msDfT %>%
  filter(move==5)%>%
  filter(farmStay==1)

szHFPlot<-ggplot(szHF,aes(size,ppue,color=habFact,group=habFact))+
  geom_point()+
  geom_line()+
  theme_bw()+
  labs(title = "Effect of recruitment parameter (habfactor)",
       subtitle = "movement=3",
       x="Farm Size",
       y="Profit per unit effort")


szHFPlot

```

```{r}

fsSz<-mdDfT %>%
  filter(move==10) %>% #0-10
  filter(farmStay==20)

szFsPlot<-ggplot(fsSz,aes(size,ppue,group=farmStay))+
  geom_point()+
  geom_line()+
  theme_bw()


szFsPlot

```

### Testing added buffer around farm

Also changed `farmStay` back to a divisor and add the buffer as multiplier. Finally a structure to the mpa/farm definitions to create evenly spaced uniform farms

```{r farmBuff}

stayMoveFunc<-function(fish,fleet,szVec,fsVec,bmVec){

  df<-data.frame(year=numeric(),
                 size=numeric(),
                 farmStay=numeric(),
                 buffMov=numeric(),
                 ppue=numeric(),
                 biomass=numeric())
  
  
    for(j in 1:length(szVec)){

      for(k in 1:length(fsVec)){
        
        for(l in 1:length(bmVec)){

        tempDf<-sim_fisheryAq(
          fish = fish,
          fleet = fleet,
          manager = create_manager(mpa_size = szVec[j], year_mpa = 15),
          num_patches = 100,
          sim_years = 50,
          burn_years = 1,
          time_step = fish$time_step,
          est_msy = FALSE,
          random_mpas = FALSE, # hoping to simplify with FALSE
          min_size = 0.05,
          mpa_habfactor = 1,
          bufferMove = 3,
          farmSize = 3,
          farmStay = fsVec[k],
          sprinkler = FALSE,
          keep_burn = FALSE)%>%
          group_by(year) %>%
          summarise(Effort = sum(effort),
                    Profits = sum(profits),
                    biomass=sum(biomass))%>%
          ungroup() %>%
          mutate(ppue = Profits/Effort)%>%
          #filter(year==max(year))%>%
          mutate(size=szVec[j],
                 farmStay=fsVec[k],
                 buffer=bmVec[l])%>%
          select(year,size,farmStay,buffMove,biomass,ppue)


      df<-df%>%
        bind_rows(.,tempDf)
        }
      
      }
      rm(tempDf)
  }
  return(df)
}


```



```{r}

## test data
#moveVecT<-c(0,10)
# sizeVecT<-c(0,0.5)
# farmVecT<-c(1,10)
# habVecT<-c(1,4)
# msDfT<-rangesFunc(fishP,fleetP,sizeVecT,farmVecT,habVecT)#test:
# head(msDfT)


### Full runs

#moveVec<-seq(0,10,by=1)
sizeVecfb<-seq(0,0.2,by=0.5)

farmVecfb<-seq(1,7,by=1)

buffVec<-seq(1,4,by=1) 

fsBm<-stayMoveFunc(fishP,fleetP,sizeVecfb,farmVecfb,buffVec)

#write.csv(fsBm,file="testRunSFHY2.csv",row.names = F)
```