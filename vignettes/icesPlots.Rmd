---
title: "ICES calculations & plots"
author: "Jessica Couture"
date: "August 25, 2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE, warning = FALSE)
```


```{r simFishAq, echo=FALSE, warning=FALSE}

sim_fisheryAq <-
  function(fish,
           fleet,
           manager,
           num_patches = 10,
           sim_years = 1,
           burn_years = 25,
           crashed_pop = 1e-3,
           random_mpas = F,
           farmSize=0, # to set regular MPA/farms of a specific size (value is numer of patches, will be distributed evenly along the total area)
           enviro = NA,
           enviro_strength = 1,
           rec_driver = "stochastic",
           est_msy = F,
           time_step,
           max_window = 10,
           min_size = 1,
           mpa_habfactor = 1,
           farm_yrs = NA,
           fallowFactor = 1,
           farmAttr=1,#value of 1 does nothing, higher increases movement to farm
           #bufferMove=1,
           farmStay=NA, # propensity to stay: 1 = no change, <1 means more likely to stay
           buffSize=2,
           sprinkler = FALSE,
           keep_burn = FALSE,
           tune_costs = FALSE) {
    msy <- NA

    p_msy <- NA

    e_msy <- NA

    max_r_msy <-  NA

    b0 <- NA

    farmYrs<-rep(F,sim_years)
    if(is.na(farm_yrs))
    {
      farmYrs[manager$year_mpa:sim_years] <- T
    } else {
      farmYrs[manager$year_mpa:sim_years] <-farm_years
    }



    if (sprinkler == FALSE & mpa_habfactor == 1){
      burn_years <- 1
    }

    if (est_msy == T) {
      e_msy_guess <- fish$m / fleet$q

      tol <- 100

      lower <- 0

      upper <- e_msy_guess * 3

      golden <- (sqrt(5) - 1) / 2

      best <- 1000

      delta_best <- 100

      counter <-  0

      while (delta_best > tol | counter < 20) {
        counter <- counter + 1

        constant <- (1 - golden) * (upper - lower)

        x1 <- lower + constant

        x2 <- upper - constant

        yield_1 <-
          estimate_msy(x1,
                       fish = fish,
                       fleet = fleet,
                       num_patches = 1)

        yield_2 <-
          estimate_msy(x2,
                       fish = fish,
                       fleet = fleet,
                       num_patches = 1)

        delta_best <-  (best -  min(yield_1, yield_2)) ^ 2

        best <- min(yield_1, yield_2)

        if (yield_1 < yield_2) {
          lower <- lower

          upper <- x2
        } else{
          lower <- x1

          upper <- upper

        }


      } # close golden while


      msy_foo <- function(seed, lower, upper, fish, fleet) {
        msy_fit <-
          nlminb(
            mean(c(lower, upper)),
            estimate_msy,
            fish = fish,
            fleet = fleet,
            lower = 0,
            seed = seed,
            num_patches = 1
          )

        out <- list()

        out$e_msy <- msy_fit$par

        out$msy <- -msy_fit$objective

        ref_points <-
          estimate_msy(
            out$e_msy,
            fish = fish,
            fleet = fleet,
            use = "other",
            seed = seed
          )

        out$b_msy <- ref_points$b_msy

        out$r_msy <- ref_points$r_msy

        return(out)

      } # close msy foo

      msy_ests <-
        map(
          sample(1:10000, 1, replace = F),
          msy_foo,
          fish = fish,
          fleet = fleet,
          lower = lower,
          upper = upper
        )

      max_r_msy <- max(map_dbl(msy_ests, "r_msy"))

      e_msy <- mean(map_dbl(msy_ests, "e_msy"))

      fleet$e_msy <- e_msy

      msy <- mean(map_dbl(msy_ests, "msy"))

      fish$msy <- msy

    } # close if estimate msy


    sim_years <- burn_years + sim_years

    if (fleet$fleet_model == "supplied-catch") {
      sim_years <- sim_years + 1
    }


    pop <-
      expand.grid(
        year = 1:sim_years,
        patch = 1:num_patches,
        age = seq(fish$min_age, fish$max_age, fish$time_step)
      ) %>%
      dplyr::mutate(
        numbers = NA,
        biomass = NA,
        ssb = NA,
        numbers_caught = NA,
        profits = NA,
        effort = 0,
        f = 0,
        mpa = F,
        cost = NA
      ) %>%
      dplyr::as_data_frame() %>%
      arrange(year, patch, age)


    effort <- vector(mode = "double", length = sim_years)

    f <- vector(mode = "double", length = sim_years)


    if (rec_driver == "stochastic") {
      # rec_devs <-
      #   rnorm(
      #     sim_years,
      #     mean = -(fish$sigma_r ^ 2) / 2,
      #     sd = fish$sigma_r
      #   )

      rec_devs <-
        rnorm(sim_years,
              mean = 0,
              sd = fish$sigma_r)

      ## autocorrelated recruitment deviations
      for (t in 2:length(rec_devs)) {
        rec_devs[t] <-
          rec_devs[t - 1] * fish$rec_ac + sqrt(1 - fish$rec_ac ^ 2) * rec_devs[t]
      }
    } else if (rec_driver == "environment") {
      if (length(enviro) != sim_years) {
        stop("environment must be same length as sim_years")
      }

      rec_devs <-
        rnorm(sim_years,
              mean = enviro_strength * enviro,
              sd = fish$sigma_r)
    }

    effort_devs <-
      rnorm(sim_years,
            mean = 0,
            sd = fleet$sigma_effort)

    for (t in 2:length(effort_devs)) {
      effort_devs[t] <-
        effort_devs[t - 1] * fleet$effort_ac + sqrt(1 - fleet$effort_ac ^ 2) * effort_devs[t]
    }

    # mpa_locations <- -1

    prop_mpas <- round(num_patches * manager$mpa_size)

    if(farmSize>0 & manager$mpa_size>0) {

      nFrms<-round(prop_mpas/farmSize)

      farmStart<-round(seq(0,num_patches,length.out = nFrms+2))[1:nFrms+1]

      farmLFunc<-function(x){
        seq(x,(x+farmSize-1),by=1)
      }

      locsList<-lapply(farmStart, farmLFunc)
      mpa_locations<-unlist(locsList)

    } else {

    if (random_mpas == T & prop_mpas > 0) {

      ms <- min(prop_mpas, max(1, min_size * num_patches)) # calculate min MPA size for random MPA generation

      cwidth <- num_patches / ms

      atemp <- tibble(patch = 1:num_patches) %>%
        dplyr::mutate(cluster = cut(patch, pmax(2,round(cwidth))))
      btemp <-
        sampling::cluster(atemp,
                          cluster = "cluster",
                          pmin(n_distinct(atemp$cluster),ceiling(prop_mpas / ms)),
                          method = "srswor")

      ctemp <- sampling::getdata(atemp, btemp) %>%
        sample_n(pmin(prop_mpas, nrow(.)))

      mpa_locations <- ctemp$patch


    } else {
      mpa_locations <-
        (1:num_patches)[0:prop_mpas] #weird zero is in case prop_mpas is zero
    }

    if (!all(is.na(manager$mpa_locations))){

      if (prop_mpas > 0){
        warning("overwriting MPA size with specific MPA locations")
      }

      mpa_locations <- manager$mpa_locations

      if (max(mpa_locations) > num_patches){
        stop("invalid MPA location supplied, make sure MPAs fit inside number of patches")
      }
    }
    }


    habitat <- rep(1, num_patches)
    habitat[mpa_locations]  <- mpa_habfactor # define habitat factor in MPA other than 1 (better (>1) or worse? (<1))

    fallowHab <- rep(1,num_patches)
    fallowHab[mpa_locations] <- fallowFactor

    if (prop_mpas == 0){ # in case you want to simulate MPA habitat but without the MPAs

      mpa_locations <- (1:num_patches)[0:prop_mpas] #weird zero is in case prop_mpas is zero

    }

    ### buffer code

    bufferLocs<-if(exists("farmStart",envir = globalenv())==T){

      c(farmStart-buffSize,farmStart+farmSize+buffSize)

      }

    n0_at_age <-
      (fish$r0 / num_patches) * exp(-fish$m * seq(fish$min_age, fish$max_age, fish$time_step))

    n0_at_age[fish$max_age + 1] <-
      n0_at_age[fish$max_age + 1] / (1 - exp(-fish$m))

    b0_at_age <- n0_at_age * fish$weight_at_age

    ssb0_at_age <- n0_at_age * fish$ssb_at_age

    # generate time series of price, cost, and q if called for

    price_series <-
      generate_timeseries(
        fish$price,
        cv = fish$price_cv,
        ac = fish$price_ac,
        percent_slope = fish$price_slope,
        time = sim_years
      )

    q <-
      generate_timeseries(
        fleet$q,
        cv = fleet$q_cv,
        ac = fleet$q_ac,
        percent_slope = fleet$q_slope,
        time = sim_years
      )

    if (length(q) == 1) {
      q <- rep(q, sim_years)
    }
    if (length(price_series) == 1) {
      price_series <- rep(price_series, sim_years)
    }

    # tune costs based on some heavy fishing at b0

    hyp_f <- fish$m #hypothetical f

    hyp_effort <- hyp_f / mean(q[(burn_years + 1):sim_years])

    hyp_f_at_age <- hyp_f * fleet$sel_at_age

    hyp_b0_catch <-
      sum((hyp_f_at_age / (hyp_f_at_age + fish$m))  * b0_at_age * (1 - exp(-(
        hyp_f_at_age + fish$m
      ))))

    b0_revenue <-
      mean(price_series[(burn_years + 1):sim_years]) * hyp_b0_catch

    hyp_profits_guess <- b0_revenue * (1 - fleet$max_cr_ratio)

    cost_guess <-
      (b0_revenue - hyp_profits_guess) / hyp_effort ^ fleet$beta

    fleet$theta <-
      (fleet$max_perc_change_f * hyp_effort) / (hyp_profits_guess / hyp_effort)

    cost_series <-
      generate_timeseries(
        cost_guess,
        cv = fleet$cost_cv,
        ac = fleet$cost_ac,
        percent_slope = fleet$cost_slope,
        time = sim_years
      )

    cost_series <- (cost_series / max(cost_series)) * cost_guess

    fleet$cost <- cost_guess

    price_frame <-
      dplyr::data_frame(year = 1:sim_years, price = price_series)

    cost_frame <- dplyr::data_frame(year = 1:sim_years, cost = cost_series)

    pop <- pop %>%
      dplyr::select(-cost) %>%
      dplyr::left_join(cost_frame, by = "year") %>%
      dplyr::left_join(price_frame, by = "year")

    pop$numbers[pop$year == 1] <- rep(n0_at_age, num_patches)

    if (fleet$cost_function == "distance from port") {
      cost_frame <-
        expand.grid(year = 1:sim_years, patch = 1:num_patches) %>%
        dplyr::as_data_frame() %>%
        dplyr::left_join(cost_frame, by = "year") %>%
        dplyr::mutate(cost = cost * (1 + fleet$cost_slope * (patch - 1)))

      pop <- pop %>%
        dplyr::select(-cost) %>%
        dplyr::left_join(cost_frame, by = c("patch", "year"))
    }


    pop <- pop %>%
      dplyr::left_join(
        dplyr::data_frame(
          age = seq(fish$min_age, fish$max_age, fish$time_step),
          ssb_at_age = fish$ssb_at_age,
          weight_at_age = fish$weight_at_age
        ),
        by = "age"
      )

    y <- 1

    model_phase <- "burn"

    # adult_move_grid <-
    #   expand.grid(
    #     source = 1:num_patches,
    #     sink = 1:num_patches
    #   ) %>%
    #   mutate(
    #     distance = source - sink,
    #     prob = 1 / ((2 * pi) ^ (1 / 2) * fish$adult_movement) * exp(-(distance) ^
    #       2 / (2 * fish$adult_movement ^ 2))
    #   ) %>%
    #   group_by(source) %>%
    #   mutate(prob_move = prob / sum(prob))

    adult_move_grid <-
      expand.grid(from = 1:num_patches, to = 1:num_patches) %>%
      as.data.frame() %>%
      dplyr::mutate(distance = purrr::map2_dbl(from, to, ~ min(
        c(abs(.x - .y),
          .x + num_patches - .y,
          num_patches - .x + .y)
      ))) %>%
      dplyr::mutate(movement = ifelse(
        is.finite(dnorm(distance, 0, fish$adult_movement)),
        dnorm(distance, 0, fish$adult_movement),
        1
      ))  %>%
      group_by(from) %>%
      dplyr::mutate(prob_move = movement / sum(movement))


    adult_move_matrix <- adult_move_grid %>%
      ungroup() %>%
      dplyr::select(from, to, prob_move) %>%
      spread(to, prob_move) %>%
      dplyr:: select(-from) %>%
      as.matrix()

    larval_move_grid <-
      expand.grid(from = 1:num_patches, to = 1:num_patches) %>%
      as.data.frame() %>%
      dplyr::mutate(distance = purrr::map2_dbl(from, to, ~ min(
        c(abs(.x - .y),
          .x + num_patches - .y,
          num_patches - .x + .y)
      ))) %>%
      dplyr::mutate(
        larval_movement = ifelse(
          from %in% mpa_locations &
            sprinkler != FALSE,
          fish$larval_movement * sprinkler,
          fish$larval_movement
        )
      )


    larval_move_grid <-  larval_move_grid %>%
      dplyr::mutate(movement = ifelse(is.finite(
        dnorm(distance, 0, fish$larval_movement)
      ), dnorm(distance, 0, larval_movement), 1))  %>%
      group_by(from) %>%
      dplyr::mutate(prob_move = movement / sum(movement))

    larval_move_matrix <- larval_move_grid %>%
      ungroup() %>%
      dplyr::select(from, to, prob_move) %>%
      spread(to, prob_move) %>%
      dplyr::select(-from) %>%
      as.matrix()


##### simulation (post-burn) #####

    farm_attr <- expand.grid(to=mpa_locations,distance=0:buffSize)%>% # limit attraction to areas close (within buffsize) to the farm (each patch of the farm)
      as.data.frame()%>%
      mutate(farmImpacts=farmAttr) # add the farmAttr value, only these will merge into the adult_move_grid df later with the appropriate distances

    #farm_stay$farmImpacts[mpa_locations]<-ifelse(is.na(farmAttr),1,farmAttr)
    #buffMov[bufferLocs]  <- ifelse(is.na(bufferMove),1,bufferMove)

    edge<-which(diff(mpa_locations)!=1)

    notLeave <- expand.grid(to=c(c(outer(mpa_locations[edge],(1:buffSize),`+`)),c(outer(mpa_locations[edge],(farmSize+(1:buffSize)),`-`)),max(mpa_locations)+(1:buffSize),mpa_locations[max(edge)+1]-(1:buffSize)),
                            from=mpa_locations)%>% # limit attraction to areas close (within buffsize) to the farm (each patch of the farm)
      as.data.frame()%>%
      mutate(toFrom=paste(to,from,sep="-"))%>%
      filter(!duplicated(toFrom))%>%
      mutate(noLve=farmStay) %>% ### propensity to STAY
      select(-toFrom)


    for (y in 1:(sim_years - 1)) {
      # Move adults

      now_year <- pop$year == y

      if (fish$density_movement_modifier < 1 & y > burn_years) {

        slope <- fish$adult_movement - (fish$adult_movement * fish$density_movement_modifier)

        # depletion = seq(0,2, by = 0.1)
        #
        # pmin(fish$adult_movement, slope * depletion + (fish$adult_movement * fish$density_movement_modifier)) %>%
        #   plot()

        how_crowded <- pop %>%
          filter(now_year) %>%
          group_by(patch) %>%
          summarise(ssb = sum(ssb)) %>%
          arrange(patch) %>%
          mutate(depletion = ssb / fish$ssb0) %>%
          mutate(move_rate = pmin(
            fish$adult_movement,
            slope * depletion + (fish$adult_movement * fish$density_movement_modifier)
          )) %>%
          select(patch, move_rate)


        adult_move_grid <-
          expand.grid(from = 1:num_patches, to = 1:num_patches) %>%
          as.data.frame() %>%
          left_join(how_crowded, by = c("from" = "patch")) %>%
          dplyr::mutate(distance = purrr::map2_dbl(from, to, ~ min(
            c(abs(.x - .y),
              .x + num_patches - .y,
              num_patches - .x + .y)
          ))) %>%
          dplyr::mutate(movement = ifelse(
            is.finite(dnorm(distance, 0, move_rate)),
            dnorm(distance, 0, move_rate),
            1
          ))


       if((y-burn_years) >= manager$year_mpa){ # apply attractor values just after farm is deployed

          adult_move_grid <- adult_move_grid %>%
            ungroup()%>%
            left_join(.,farm_attr)%>% # merge attractor values with the 'to' patches
            left_join(.,notLeave,by=c("to","from"))%>%
            mutate(farmImpacts=ifelse(is.na(noLve),farmImpacts,noLve),
                   farmImpacts=replace_na(farmImpacts,1),
                   movement=movement*farmImpacts) %>% ## adjust 'prob_move' by 'farm_attr'; increase probabilty that move FROM farm locations
            select(-noLve)%>%
            group_by(from) %>%
            dplyr::mutate(prob_move = movement / sum(movement))

       } else {
          adult_move_grid <- adult_move_grid%>%
            group_by(from) %>%
            dplyr::mutate(prob_move = movement / sum(movement))
        }



        adult_move_matrix <- adult_move_grid %>%
          ungroup() %>%
          dplyr::select(from, to, prob_move) %>%
          # group_by(to) %>% 
          # mutate(grouped_id = row_number()) %>%
          # ungroup()%>%
          spread(to, prob_move) %>%
          dplyr:: select(-from) %>%
          as.matrix()

      }

      if (num_patches > 1) {
        pop[now_year &
              pop$age > fish$min_age, ] <-
          move_fish(
            pop %>% filter(year == y, age > fish$min_age),
            fish = fish,
            num_patches = num_patches,
            move_matrix = adult_move_matrix
            # move_matrix = (adult_move_matrix * adult_density_modifier) / rowSums(((adult_move_matrix) * (adult_density_modifier)))
            # move_matrix = exp(log(adult_move_matrix) + log(adult_density_modifier)) / rowSums(exp(log(adult_move_matrix) + log(adult_density_modifier)))
          )
      }

      # change management

      if ((y - burn_years) == manager$year_mpa) {
        pop$mpa[pop$patch %in% mpa_locations & pop$year >= y] <- T

        if (fleet$mpa_reaction == "leave") {
          mpa_effort <-
            sum(pop$effort[pop$patch %in% mpa_locations &
                             pop$year == (y - 1) & pop$age == 0])

          effort[y - 1] <-   effort[y - 1] - mpa_effort


        }

      }
      # Adjust fleet
      if (y > (burn_years)) {
        b0 <- sum(pop$biomass[pop$year == burn_years])

        if (fleet$fleet_model == "open-access" &
            tune_costs == TRUE) {
          #located here to allow for b0

          # huh <- map_dbl(seq(0.01,0.9, by = 0.1), estimate_costs, fish = fish,
          #                fleet = fleet,
          #                b_ref_oa = fleet$b_ref_oa,
          #                lags = 10,
          #                num_patches = num_patches,
          #                sim_years = sim_years,
          #                burn_years = burn_years
          # )

          tuned_cr_ratio <-
            nlminb(
              c(0.3),
              estimate_costs,
              fish = fish,
              fleet = fleet,
              b_ref_oa = fleet$b_ref_oa,
              lower = c(1e-3,1e-3),
              upper = c(0.75,10),
              lags = fleet$profit_lags,
              num_patches = num_patches,
              sim_years = sim_years,
              burn_years = burn_years,
              sprinkler = sprinkler,
              mpa_habfactor = mpa_habfactor
            )

          # tuned_cr_ratio <-
          #   nlminb(
          #     c(0.3,0.05),
          #     estimate_costs,
          #     fish = fish,
          #     fleet = fleet,
          #     b_ref_oa = fleet$b_ref_oa,
          #     lower = c(1e-3,1e-3),
          #     upper = c(0.75,10),
          #     lags = 10,
          #     num_patches = num_patches,
          #     sim_years = sim_years,
          #     burn_years = burn_years,
          #     sprinkler = sprinkler,
          #     mpa_habfactor = mpa_habfactor
          #   )
          tune_costs <- FALSE

          fleet$max_cr_ratio <- tuned_cr_ratio$par[1]

          # fleet$max_perc_change_f <- tuned_cr_ratio$par[2]

          hyp_f <- fish$m #hypothetical f

          hyp_effort <- hyp_f / mean(q[(burn_years + 1):sim_years])

          hyp_f_at_age <- hyp_f * fleet$sel_at_age

          hyp_b0_catch <-
            sum((hyp_f_at_age / (hyp_f_at_age + fish$m))  * b0_at_age * (1 - exp(-(
              hyp_f_at_age + fish$m
            ))))

          b0_revenue <-
            mean(price_series[(burn_years + 1):sim_years]) * hyp_b0_catch

          hyp_profits_guess <- b0_revenue * (1 - fleet$max_cr_ratio)

          cost_guess <-
            (b0_revenue - hyp_profits_guess) / hyp_effort ^ fleet$beta

          fleet$theta <-
            (fleet$max_perc_change_f * hyp_effort) / (hyp_profits_guess / hyp_effort)

          cost_series <-
            generate_timeseries(
              cost_guess,
              cv = fleet$cost_cv,
              ac = fleet$cost_ac,
              percent_slope = fleet$cost_slope,
              time = sim_years
            )

          cost_series <- (cost_series / max(cost_series)) * cost_guess

          fleet$cost <- cost_guess

          cost_frame <- dplyr::data_frame(year = 1:sim_years, cost = cost_series)

          pop <- pop %>%
            dplyr::select(-cost) %>%
            dplyr::left_join(cost_frame, by = "year")

          if (fleet$cost_function == "distance from port") {
            cost_frame <-
              expand.grid(year = 1:sim_years, patch = 1:num_patches) %>%
              dplyr::as_data_frame() %>%
              dplyr::left_join(cost_frame, by = "year") %>%
              dplyr::mutate(cost = cost * (1 + fleet$cost_slope * (patch - 1)))

            pop <- pop %>%
              dplyr::select(-cost) %>%
              dplyr::left_join(cost_frame, by = c("patch", "year"))
          }

        }

        if (y == (burn_years + 2) &
            fleet$fleet_model == "open-access") {
          profits <- pop %>%
            filter(year >= (y - (1 + fleet$profit_lags)), year < y) %>%
            group_by(year) %>%
            summarise(profits = sum(profits))

          total_initial_profits <- mean(profits$profits)

        }

        previous_max <-
          ifelse(y > (burn_years + 1), max(effort[max(1, (y - 1 - max_window)):(y - 1)]), fleet$initial_effort)

        effort[y] <- determine_effort(
          last_effort = ifelse(y > (burn_years + 1), effort[y - 1], fleet$initial_effort),
          fleet = fleet,
          fish = fish,
          y = y,
          burn_years = burn_years,
          pop = pop,
          mpa = mpa,
          num_patches = num_patches,
          effort_devs = effort_devs,
          profit_lags = fleet$profit_lags,
          previous_max = previous_max
        )

      }

      pop[now_year, "effort"] <-
        distribute_fleet(
          pop = pop %>% filter(year == y),
          prior_profits = pop$profits[pop$year == (y - 1)],
          year = y,
          burn_years = burn_years,
          effort = effort[y],
          fleet = fleet,
          num_patches = num_patches,
          mpa = mpa
        )

      if (fleet$tech_rate > 0 & y > burn_years) {
        q[y] <-
          q[y - 1] + pmax(0,
                          rnorm(1, fleet$tech_rate * q[y - 1], fleet$tech_rate * fleet$q))
      }

      pop[now_year, "f"] <-
        pop[now_year, "effort"] * q[y]

      # grow and die -----
      pop[pop$year == (y + 1), "numbers"] <-
        pop[now_year, ] %>%
        group_by(patch) %>%
        dplyr::mutate(numbers = grow_and_die(
          numbers = numbers,
          f = f,
          mpa = mpa,
          fish = fish,
          fleet = fleet,
          y = y
        )$survivors) %>%
        ungroup() %>%
        {
          .$numbers
        }

      pop[now_year, "numbers_caught"] <-
        pop[now_year, ] %>%
        group_by(patch) %>%
        dplyr::mutate(
          numbers_caught = grow_and_die(
            numbers = numbers,
            f = f,
            mpa = mpa,
            fish = fish,
            fleet = fleet,
            y = y
          )$caught
        ) %>%
        ungroup() %>%
        {
          .$numbers_caught
        }

      pop <- pop %>%
        dplyr::mutate(patch_age_costs = ((cost) * (effort) ^ fleet$beta) / fish$max_age) %>% # divide costs up among each age class
        dplyr::mutate(
          ssb = numbers * ssb_at_age,
          biomass = numbers * weight_at_age,
          biomass_caught = numbers_caught * weight_at_age,
          profits = biomass_caught * price - patch_age_costs
        )

      # spawn ----

      # if (is.na(spawning_season) | ((((year) - floor(year))/spawning_season) == 1))
      pop$numbers[pop$year == (y + 1) &
                    pop$age == fish$min_age] <-
        calculate_recruits(
        #calculate_recruitsFarm(
          #farmYrs=farmYrs,
          pop = pop[pop$year == y, ],
          fish = fish,
          num_patches = num_patches,
          phase = model_phase,
          move_matrix = larval_move_matrix,
          rec_devs = rec_devs[y + 1],
          patch_habitat = habitat#,
          #fallowHab = fallowHab
        )


      if (y == burn_years) {
        fish$ssb0 <- pop %>%
          filter(year == burn_years) %>%
          group_by(patch) %>%
          summarise(ssb = sum(ssb)) %>%
          ungroup() %>%
          {
            (.$ssb)
          }

        model_phase <- "recruit"

        effort[y + 1] <- fleet$initial_effort
      }
    }
    rec_mat <- dplyr::data_frame(year = 1:sim_years, rec_dev = rec_devs)

    enviro_mat <- dplyr::data_frame(year = 1:sim_years, enviro = enviro)

    og <- burn_years
    if (keep_burn == TRUE) {
      burn_years <- -99
    }

    pop <- pop %>%
      dplyr::left_join(rec_mat, by = "year") %>%
      dplyr::left_join(enviro_mat, by = "year") %>%
      dplyr::filter(year > burn_years, year < max(year)) %>%
      dplyr:: mutate(
        burn = year <= og,
        eventual_mpa = patch %in% mpa_locations,
        msy = msy,
        e_msy = e_msy,
        b0 = b0
      )

    return(pop)
  }

###################################################################################################

```


Testing the impacts of MPA vs farm (compared to no MPA) under constant effort and open access fishery management. The species used here is loosely a pollock species: Saithe ([*P. virens*](https://www.fishbase.se/summary/Pollachius-virens.html)), which is highly mobile and has commonly been found at high abundances around farms. Most of the biological data I am pulling from fishbase, but movement has been updated to be 10 for adults and 5 for juveniles.   
  
I decided to focus on a farm's ability to sustain higher numbers of fish and adjust this with the parameter *fishStay* that increases the likelihood that surrounding fish (distance of 'surrounding' defined by *buffSize*) move to a farm cell. Right now this relationship is just linear and linear mulitplier of movement probabilities, but I'd like to discuss and try other relationsips. 

The other element I change is the the size of the farm (defined by *farmSize*), which are uniform and evenly spaced across the area based on total 'protected' area. I also include one large MPA compared to several separate farms. 

Common parameters include:

* MPA implemented in year 50
* Total area protected/farmed = 10%
* Initial effort = 10,000
* Test species: *Pollachius virens*, aka. Saithe
* Total patches = 100, movement = 10


```{r commonParams}

library(spasm)
library(FishLife)
library(spasm)
library(ggridges)
library(gganimate)
library(tidyverse)
library(cowplot)

fishPv <-
  create_fish(
  scientific_name = "Pollachius virens",
  query_fishlife = T,
  mat_mode = "length",
  time_step = 1,
  # sigma_r = 0,
  steepness = 0.6,
  r0 = 4290000,
  # rec_ac = 0,
  adult_movement = 1,
  larval_movement = 7,
  density_dependence_form = 3, # change to 2 to use the habfactor
  density_movement_modifier = 0.9,
  price = 100000
  )
          
fishPv$common_name<-"Saithe"

head(fishPv)

```

## "Bad" management  

Open access, *leave* when MPA takes effect


```{r oaTesting}

fleetOAt <- create_fleet(
  fish = fishPv,
  cost = 0.1,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "open-access",#"constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.2 * fishPv$linf,
  initial_effort = 10000,
  # profit_lags =  1,
  # beta = 2,
  # max_cr_ratio = 0.9,
  # max_perc_change_f = 0.5,
  effort_allocation = 'profit-gravity',
  mpa_reaction = "concentrate"
)

oaNullT <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetOAt,
  manager = create_manager(mpa_size = 0, year_mpa = 100),
  num_patches = 100,
  sim_years = 200,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE)%>%
  mutate(run="noMPA")

oaMPAt <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetOAt,
  manager = create_manager(mpa_size = 0.1, year_mpa = 100),
  num_patches = 100,
  sim_years = 200,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  #min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="MPA")


### format and plot

oaTEST<-bind_rows(oaNullT,oaMPAt)%>%
  mutate(ppue=profits/effort)%>%
  group_by(year,run)%>%
  summarise(biomass=sum(biomass),
            catch=sum(numbers_caught),
            ppue=sum(ppue)) %>%
  ungroup()

oaBMt<-ggplot(oaTEST[oaTEST$year>49,],aes(year,biomass,color=run,group=run))+
  geom_line()+
  scale_color_brewer(palette="Dark2")+
  labs(y="Biomass (MT)")+
  theme_bw()+ theme(legend.title = element_blank())

oaCatchT<-ggplot(oaTEST[oaTEST$year>49,],aes(year,catch,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()

oaPpueT<-ggplot(oaTEST[oaTEST$run=="MPA",],aes(year,ppue,color=run,group=run))+
  geom_line()+
  labs()+
  theme_bw()


plot_grid(titleOA,oaPpueT,oaBMt,oaCatchT,ncol=1,rel_heights = c(0.15,1,1,1))


```



```{r openAccess, echo=TRUE}


fleetOA <- create_fleet(
  fish = fishPv,
  #cost = 0.00001,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "open-access",#"constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.2 * fishPv$linf,
  initial_effort = 10000,
  profit_lags =  1,
  beta = 2,
  max_cr_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'profit-gravity',
  mpa_reaction = "concentrate"
)

```



```{r oaNull}
### No MPA
oaNull <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0, year_mpa = 100),
  num_patches = 100,
  sim_years = 200,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE)%>%
  mutate(run="noMPA")

#plot_spasm(oaNull, type = "totals", font_size = 12)

### looking at the data

# oaNtot<-oaNull %>%
#   group_by(year)%>%
#   mutate(effort=sum(effort),
#           profits=sum(profits),
#           biomass=sum(biomass),
#           catch=sum(numbers_caught))
# 
# ggplot(oaNtot,aes(year,effort))+
#   geom_line()+
#   theme_bw()

```


```{r oaMPA}
### Standard MPA
oaMPA10 <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0.1, year_mpa = 50),
  num_patches = 100,
  sim_years = 200,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  #min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="MPA")

#plot_spasm(oaMPA10, type = "totals", font_size = 12)

oaMPA15 <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0.15, year_mpa = 50),
  num_patches = 100,
  sim_years = 200,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE)%>%
  mutate(run="mpa15")

```


```{r oaAq}
## Aquaculture
# oaAq <- sim_fisheryAq(
#   fish = fishPv,
#   fleet = fleetOA,
#   manager = create_manager(mpa_size = 0.1, year_mpa = 50),
#   num_patches = 100,
#   sim_years = 100,
#   burn_years = 50,
#   time_step = fishPv$time_step,
#   est_msy = FALSE,
#   random_mpas = FALSE,
#   min_size = 0.05,
#   mpa_habfactor = 1,
#   sprinkler = FALSE,
#   keep_burn = FALSE,
#   farmSize = 2,
#   farmAttr = 1.5,
#   farmStay=1,
#   buffSize=5,
#   tune_costs = TRUE) %>%
#   mutate(run="farm")

#plot_spasm(oaAq, type = "totals", font_size = 12)

oaAqStay <- sim_fisheryAq(
  fish = fishPv,
  fleet = fleetOA,
  manager = create_manager(mpa_size = 0.1, year_mpa = 50),
  num_patches = 100,
  sim_years = 200,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = FALSE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE,
  farmSize = 2,
  farmAttr = 1.5,
  farmStay=0.7,
  buffSize=7) %>%
  mutate(run="farmWStay")

# oaAqStay2 <- sim_fisheryAq(
#   fish = fishPv,
#   fleet = fleetOA,
#   manager = create_manager(mpa_size = 0.1, year_mpa = 50),
#   num_patches = 100,
#   sim_years = 100,
#   burn_years = 50,
#   time_step = fishPv$time_step,
#   est_msy = FALSE,
#   random_mpas = FALSE,
#   min_size = 0.05,
#   mpa_habfactor = 1,
#   sprinkler = FALSE,
#   keep_burn = FALSE,
#   farmSize = 2,
#   farmAttr = 2,
#   farmStay=0.7,
#   buffSize=5) %>%
#   mutate(run="farmWStay2")

```

```{r oaAll}

oaAll<-bind_rows(oaNull,oaMPA10,oaMPA15,oaAqStay)%>%
  mutate(ppue=profits/effort)%>%
  group_by(year,run)%>%
  summarise(biomass=sum(biomass),
            catch=sum(numbers_caught),
            ppue=sum(ppue)) %>%
  ungroup()

oaBM<-ggplot(oaAll[oaAll$year>49,],aes(year,biomass,color=run,group=run))+
  geom_line()+
  scale_color_brewer(palette="Dark2")+
  labs(y="Biomass (MT)")+
  theme_bw()+ theme(legend.title = element_blank())

oaCatch<-ggplot(oaAll[oaAll$year>49,],aes(year,catch,color=run,group=run))+
  geom_line()+
  scale_color_brewer(palette="Dark2")+
  labs(y="Catch (MT)")+
  theme_bw()+ theme(legend.title = element_blank())

oaPpue<-ggplot(oaAll,aes(year,ppue,color=run,group=run))+
  geom_line()+
  theme_bw()



titleOA<-ggdraw()+draw_label("Open access, DDF=3,LM=7, fs=2, sprinkler=T")

plot_grid(titleOA,oaBM,oaCatch,ncol=1,rel_heights = c(0.15,1,1))

```

***

## "Good" management  

Constant Effort, effort concentrates when MPA takes effect initial fishing effort is high


```{r constEff, echo=TRUE}


fleetCE <- create_fleet(
  fish = fishPv,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.1 * fishPv$linf,
  initial_effort = 10000,
  profit_lags =  5,
  beta = 2,
  max_cr_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'gravity',
  mpa_reaction = "concentrate"
)

```



```{r ceNull}

### No MPA

ceNull <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetCE,
  manager = create_manager(mpa_size = 0, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = TRUE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="noMPA")

plot_spasm(ceNull, type = "totals", font_size = 12)

```



```{r ceMPA}
### Standard MPA
ceMPA <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetCE,
  manager = create_manager(mpa_size = 0.1, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = TRUE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="mpa")

#plot_spasm(ceMPA, type = "totals", font_size = 12)

```


```{r ceAq}
## Aquaculture
ceAq <- sim_fisheryAq(
  fish = fishPv,
  fleet = fleetCE,
  manager = create_manager(mpa_size = 0.1, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = TRUE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE,
  farmSize = 2,
  farmAttr = 1.5,
  farmStay = 0.7,
  buffSize=5) %>%
  mutate(run="farm")

#plot_spasm(ceAq, type = "totals", font_size = 12)


```

```{r ceAll}

ceAll<-bind_rows(ceNull,ceMPA,ceAq)%>%
  group_by(year,run)%>%
  summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
  ungroup()%>%
  mutate(PPUE=profits/effort)

ceBM<-ggplot(ceAll[ceAll$year>49,],aes(year,biomass,color=run,group=run))+
  geom_line()+
  theme_bw()

ceCatch<-ggplot(ceAll[ceAll$year>49,],aes(year,catch,color=run,group=run))+
  geom_line()+
  theme_bw()


titleCE<-ggdraw()+draw_label("Constant Effort")

plot_grid(titleCE,ceBM,ceCatch,ncol=1,rel_heights = c(0.15,1,1))

```

***

## Quota management  

Constant Yield, effort concentrates when MPA takes 


```{r constYld, echo=TRUE}


fleetCY <- create_fleet(
  fish = fishPv,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "constant-catch",
  sigma_effort = 0,
  length_50_sel = 0.3 * fishPv$linf,
  initial_effort = 10000,
  profit_lags =  5,
  beta = 2,
  max_cr_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'simple',
  mpa_reaction = "concentrate"
)

```



```{r cyNull}

### No MPA

cyNull <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetCY,
  manager = create_manager(mpa_size = 0, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = TRUE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="noMPA")

plot_spasm(cyNull, type = "totals", font_size = 12)

```



```{r cyMPA}
### Standard MPA
cyMPA <- spasm::sim_fishery(
  fish = fishPv,
  fleet = fleetCE,
  manager = create_manager(mpa_size = 0.1, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = TRUE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)%>%
  mutate(run="mpa")

#plot_spasm(cyMPA, type = "totals", font_size = 12)

```


```{r cyAq}
## Aquaculture
cyAq <- sim_fisheryAq(
  fish = fishPv,
  fleet = fleetCY,
  manager = create_manager(mpa_size = 0.1, year_mpa = 50),
  num_patches = 100,
  sim_years = 100,
  burn_years = 50,
  time_step = fishPv$time_step,
  est_msy = TRUE,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE,
  farmSize = 2,
  farmAttr = 1.5,
  farmStay = 0.7,
  buffSize=5) %>%
  mutate(run="farm")

#plot_spasm(cyAq, type = "totals", font_size = 12)


```

```{r cyAll}

cyAll<-bind_rows(cyNull,cyMPA,cyAq)%>%
  group_by(year,run)%>%
  summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
  ungroup()%>%
  mutate(PPUE=profits/effort)

cyBM<-ggplot(cyAll,aes(year,biomass,color=run,group=run))+
  geom_line()+
  theme_bw()

cyCatch<-ggplot(cyAll,aes(year,catch,color=run,group=run))+
  geom_line()+
  theme_bw()


titleCY<-ggdraw()+draw_label("Constant Yield")

plot_grid(titleCY,cyBM,cyCatch,ncol=1,rel_heights = c(0.15,1,1))

```

***

## Testing staying power of the farm: *farmAttr*

```{r attrParams}

frmAttr<-seq(1,2,by=0.25)

frmAttrSeq<-seq(1,5,by=1)

```

Here I am varying the dampening of adult movement at and around the farm (`r frmAttr`) and plotting the results with a standard MPA and no MPA as well (from data above). *farmSize* is held constant at 2 patches and *farmStay* at 1 for this simulation each and *adult_movement* = `r fishPv$adult_movement`.

```{r attrOA}

attr<-data.frame(year=numeric(),
                 fAttr=numeric(),
                 biomass=numeric(),
                 catch=numeric())


for(i in 1:length(frmAttrSeq)) {
  
  dfAt <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA, ### OPEN ACCESS
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = 2,
    farmAttr = frmAttrSeq[i],
    farmStay=1,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(fAttr=frmAttrSeq[i]) %>%
    select(year, fAttr, biomass, catch)
  
  attr<-bind_rows(attr,dfAt)

}

attr2<-attr %>%
  #filter(fAttr %in% frmAttr,
        # year>49)%>%
  mutate(type="farm") %>%
  bind_rows(.,oaAll%>%
              mutate(fAttr=1)%>%
              filter(run %in% c("mpa10","mpa15","noMPA")) %>%
              rename(type=run) %>%
              select(year,fAttr, biomass, catch,type))%>%
  filter(year>49)

attrBM<-ggplot(attr2,aes(year,biomass,color=as.factor(fAttr),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

attrCatch<-ggplot(attr2,aes(year,catch,color=as.factor(fAttr),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

attrPlt<-plot_grid(titleOA,attrBM,attrCatch,ncol=1,rel_heights = c(0.15,1,1))

attrPlt
```


```{r attrCE}

attrCE<-data.frame(year=numeric(),
                 fAttr=numeric(),
                 biomass=numeric(),
                 catch=numeric())


for(i in 1:length(frmAttrSeq)) {
  
  dfAtCE <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetCE, ### constant effort
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = 2,
    farmAttr = frmAttrSeq[i],
    farmStay = 1,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(fAttr=frmAttrSeq[i]) %>%
    select(year, fAttr, biomass, catch)
  
  attrCE<-bind_rows(attrCE,dfAtCE)

}

attrCE2<-attrCE %>%
  filter(fAttr %in% frmAttr,
         year>49)%>%
  mutate(type="farm") %>%
  bind_rows(.,ceAll%>%
              mutate(fAttr=1)%>%
              filter(run %in% c("mpa","noMPA")) %>%
              rename(type=run) %>%
              select(year,fAttr, biomass, catch,type))%>%
  filter(year>49)

attrBmCe<-ggplot(attrCE2,aes(year,biomass,color=as.factor(fAttr),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

attrCatchCE<-ggplot(attrCE2,aes(year,catch,color=as.factor(fAttr),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(titleCE,attrBmCe,attrCatchCE,ncol=1,rel_heights = c(0.15,1,1))
```

***

## Testing staying power of the farm: *farmStay*

```{r stayParams}

frmStay<-c(0.1,0.25,0.5,0.75,1)

frmStaySeq<-seq(0.1,1,by=0.1)

```

Here I am varying the dampening of adult movement at and around the farm (`r frmStay`) and plotting the results with a standard MPA and no MPA as well (from data above). *farmSize* is held constant at 2 patches, *farmAttr* at 1 for this simulation each and *adult_movement* = `r fishPv$adult_movement`.

```{r stayOA}

stay<-data.frame(year=numeric(),
                 fStay=numeric(),
                 biomass=numeric(),
                 catch=numeric())


for(i in 1:length(frmStaySeq)) {
  
  dfSt <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA, ### OPEN ACCESS
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = 2,
    farmStay = frmStaySeq[i],
    farmAttr=1,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(fStay=frmStaySeq[i]) %>%
    select(year, fStay, biomass, catch)
  
  stay<-bind_rows(stay,dfSt)

}

stay2<-stay %>%
  filter(fStay %in% frmStay,
         year>49)%>%
  mutate(type="farm") %>%
  bind_rows(.,oaAll%>%
              mutate(fStay=1)%>%
              filter(run %in% c("mpa","noMPA")) %>%
              rename(type=run) %>%
              select(year,fStay, biomass, catch,type))%>%
  filter(year>49)

stayBM<-ggplot(stay2,aes(year,biomass,color=as.factor(fStay),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

stayCatch<-ggplot(stay2,aes(year,catch,color=as.factor(fStay),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

stayPlt<-plot_grid(titleOA,stayBM,stayCatch,ncol=1,rel_heights = c(0.15,1,1))

stayPlt
```


```{r stayCE}

stayCE<-data.frame(year=numeric(),
                 fStay=numeric(),
                 biomass=numeric(),
                 catch=numeric())


for(i in 1:length(frmStaySeq)) {
  
  dfStCE <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetCE, ### constant effort
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = 2,
    farmStay = frmStaySeq[i],
    farmAttr=1,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(fStay=frmStaySeq[i]) %>%
    select(year, fStay, biomass, catch)
  
  stayCE<-bind_rows(stayCE,dfStCE)

}

stayCE2<-stayCE %>%
  filter(fStay %in% frmStay,
         year>49)%>%
  mutate(type="farm") %>%
  bind_rows(.,ceAll%>%
              mutate(fStay=1)%>%
              filter(run %in% c("mpa","noMPA")) %>%
              rename(type=run) %>%
              select(year,fStay, biomass, catch,type))%>%
  filter(year>49)

stayBmCe<-ggplot(stayCE2,aes(year,biomass,color=as.factor(fStay),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

stayCatchCE<-ggplot(stayCE2,aes(year,catch,color=as.factor(fStay),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(titleCE,stayBmCe,stayCatchCE,ncol=1,rel_heights = c(0.15,1,1))
```

***

## Testing orientation of protected spaces: *farmSize*

```{r sizeParams}

frmSzs<-c(0,1,3,5)

frmSzsSeq<-c(0,1,2,5)

```



One large farm versus multiple smaller farms of different sizes, MPAs are all one large MPA. 
Testing: *farmSize* = `r frmSzs`. *farmStay* is held at 1.5 for these runs.
**a farm size = 0 indicates no dividing up, so there will be one large farm*

```{r sizeOA}

shape<-data.frame(year=numeric(), 
                  farmSize=numeric(),
                  biomass=numeric(),
                  catch=numeric(),
                  PPUE=numeric())


for(i in 1:length(frmSzsSeq)) {
  
  df <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA, ### OPEN ACCESS
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = frmSzsSeq[i], #####
    farmStay = 1,
    farmAttr = 1,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(PPUE=profits/effort,
           farmSize=frmSzsSeq[i]) %>%
    select(year, farmSize, biomass, catch, PPUE)
  
  shape<-bind_rows(shape,df)

}

shape<-shape%>%
  mutate(farmSize=replace(farmSize,farmSize==0,10))

shape2<-shape %>%
  #filter(farmSize %in% frmSzs)%>%
  mutate(type="farm") %>%
  bind_rows(.,oaAll%>%
              mutate(farmSize=0)%>%
              filter(run %in% c("mpa","noMPA")) %>%
              rename(type=run) %>%
              select(year,farmSize, biomass, catch,type)) %>%
  filter(year>49)

shpBM<-ggplot(shape2,aes(year,biomass,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpCatch<-ggplot(shape2,aes(year,catch,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(titleOA,shpBM,shpCatch,ncol=1,rel_heights = c(0.15,1,1))
```

```{r sizeCE}

shapeCE<-data.frame(year=numeric(), 
                  farmSize=numeric(),
                  biomass=numeric(),
                  catch=numeric(),
                  PPUE=numeric())


for(i in 1:length(frmSzsSeq)) {
  
  df <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetCE, ### CONSTANT EFFORT
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = frmSzsSeq[i], #####
    farmStay = 1,
    farmAttr = 1,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(effort=sum(effort),
            profits=sum(profits),
            biomass=sum(biomass),
            catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(PPUE=profits/effort,
           farmSize=frmSzsSeq[i]) %>%
    select(year, farmSize, biomass, catch, PPUE)
  
  shapeCE<-bind_rows(shapeCE,df)


}

shapeCE<-shapeCE%>%
  mutate(farmSize=replace(farmSize,farmSize==0,10))

shapeCE2<-shapeCE %>%
  #filter(farmSize %in% frmSzs)%>%
  mutate(type="farm") %>%
  bind_rows(.,ceAll%>%
              mutate(farmSize=0)%>%
              filter(run %in% c("mpa","noMPA")) %>%
              rename(type=run) %>%
              select(year,farmSize, biomass, catch,PPUE,type))%>%
  filter(year>49)


shpBMCE<-ggplot(shapeCE2,aes(year,biomass,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

shpCatchCE<-ggplot(shapeCE2,aes(year,catch,color=as.factor(farmSize),linetype=type))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(titleCE,shpBMCE,shpCatchCE,ncol=1,rel_heights = c(0.15,1,1))

```

***

## Testing impacts of population movement: *adult_movement* 

```{r moveParams}

popMove<-c(1,2,4,10,20) 
## default is 2

popMoveSeq<-c(1,seq(2,50,by=2))

```

*adult_movement* is defined in the `create_fish` function and can also be set manually. This variable (here, *movePar*) defines the movement rate of the fish compared to the overall area of the population (here 100 patches). 

*farmStay* is held constant at 1.5 for each run, *farmSize* is also held constant at 2 cells, evenly spaced 

```{r moveOA}

move<-data.frame(year=numeric(),
                 movePar=numeric(),
                 run=as.character(),
                 biomass=numeric(), 
                 catch=numeric())

for(i in 1:length(popMoveSeq)){
  
fishPv$adult_movement<-popMoveSeq[i]
          
  
  dfmv <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA,
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = 2,
    farmStay = 1.5,
    farmAttr = 0.7,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(movePar=popMoveSeq[i],
           run="farm") %>%
    select(year, movePar,run,biomass, catch)
  
  mvNo<-spasm::sim_fishery(
    fish = fishPv,
    fleet = fleetOA,
    manager = create_manager(mpa_size = 0, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE
    )%>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(movePar=popMoveSeq[i],
           run="noMPA") %>%
    select(year, movePar,run,biomass, catch)
  
  mvMpa<-spasm::sim_fishery(
    fish = fishPv,
    fleet = fleetOA,
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE
    )%>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(movePar=popMoveSeq[i],
           run="mpa") %>%
    select(year, movePar,run,biomass, catch)

  move<-bind_rows(move,dfmv,mvNo,mvMpa)  
  
}

move2<-move%>%
  filter(year>49,
         movePar %in% popMove)

mvBM<-ggplot(move2,aes(year,biomass,color=as.factor(movePar),linetype=run))+
  geom_line()+
  labs()+
  theme_bw()

mvCatch<-ggplot(move2,aes(year,catch,color=as.factor(movePar),linetype=run))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(titleOA,mvBM,mvCatch,ncol=1,rel_heights = c(0.15,1,1))
```


```{r mpaMoveOA}

mpaMove<-move2%>%
  filter(run %in% c("noMPA","mpa"))

mvBMmpa<-ggplot(mpaMove,aes(year,biomass,color=as.factor(movePar),linetype=run))+
  geom_line()+
  labs(title = "MPAs only")+
  theme_bw()

mvCatchmpa<-ggplot(mpaMove,aes(year,catch,color=as.factor(movePar),linetype=run))+
  geom_line()+
  theme_bw()

plot_grid(mvBMmpa,mvCatchmpa,ncol=1,rel_heights = c(1.15,1))

```


```{r moveCE}

moveCE<-data.frame(year=numeric(),
                 movePar=numeric(),
                 run=as.character(),
                 biomass=numeric(), 
                 catch=numeric())

for(i in 1:length(popMoveSeq)){
  
fishPv$adult_movement<-popMoveSeq[i]
          
  
  dfmv <- sim_fisheryAq(
    fish = fishPv,
    fleet = fleetCE,
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = 2,
    farmStay = 1.5,
    farmAttr = 0.7,
    buffSize=5) %>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(movePar=popMoveSeq[i],
           run="farm") %>%
    select(year, movePar,run,biomass, catch)
  
  mvNo<-spasm::sim_fishery(
    fish = fishPv,
    fleet = fleetCE,
    manager = create_manager(mpa_size = 0, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE
    )%>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(movePar=popMoveSeq[i],
           run="noMPA") %>%
    select(year, movePar,run,biomass, catch)
  
  mvMpa<-spasm::sim_fishery(
    fish = fishPv,
    fleet = fleetCE,
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    mpa_habfactor = 1,
    sprinkler = FALSE,
    keep_burn = FALSE
    )%>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught)) %>%
    ungroup()%>%
    mutate(movePar=popMoveSeq[i],
           run="mpa") %>%
    select(year, movePar,run,biomass, catch)

  moveCE<-bind_rows(moveCE,dfmv,mvNo,mvMpa)  
  
}

moveCE2<-moveCE%>%
  filter(year>49,
         movePar %in% popMove)

mvBMce<-ggplot(moveCE2,aes(year,biomass,color=as.factor(movePar),linetype=run))+
  geom_line()+
  labs()+
  theme_bw()

mvCatchCE<-ggplot(moveCE2,aes(year,catch,color=as.factor(movePar),linetype=run))+
  geom_line()+
  labs()+
  theme_bw()

plot_grid(titleCE,mvBMce,mvCatchCE,ncol=1,rel_heights = c(0.15,1,1))
```

\pagebreak

# Relative plots

Biomass and catches in MPA and farm scenarios relative to status quo (no farm/MPA) at varying levels of *farmAttr*, *farmStay*, *farmSize*, and *adult_movement*. 

```{r sqMpa}

## Open access values
sqBMoa<-sum(oaNull[oaNull$year==max(oaNull$year),"biomass"])
sqCtchoa<-sum(oaNull[oaNull$year==max(oaNull$year),"numbers_caught"])

mpaBMoa<-sum(oaMPA[oaMPA$year==max(oaMPA$year),"biomass"])
mpaCtchoa<-sum(oaMPA[oaMPA$year==max(oaMPA$year),"numbers_caught"])

## constant effort values
sqBMCE<-sum(ceNull[ceNull$year==max(ceNull$year),"biomass"])
sqCtchCE<-sum(ceNull[ceNull$year==max(ceNull$year),"numbers_caught"])

mpaBMCE<-sum(ceMPA[ceMPA$year==max(ceMPA$year),"biomass"])
mpaCtchCE<-sum(ceMPA[ceMPA$year==max(ceMPA$year),"numbers_caught"])

```

#### Farm attraction

Since the farmAttr is included as a muliplier to movement, we get a linear result. *Should* I be using a linear relationship or other? What else could it be?

```{r relAttrOA}


relAttrOA<-attr %>%
    filter(year==max(year)) %>%
    group_by(fAttr)%>%
    summarise(totBm=sum(biomass),
              totCtch=sum(catch))%>%
    mutate(relBM=totBm-sqBMoa,
           relCtch=totCtch-sqCtchoa)%>%
    ungroup()

  ### plots

    relAttr_bmOA<-ggplot(relAttrOA,aes(fAttr,relBM))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqBMoa-mpaBMoa,linetype=2)+
      labs(x="",y="Biomass relative to status quo (kg)",title="Open Access")+
      theme_bw()

    relAttr_CtchOA<-ggplot(relAttrOA,aes(fAttr,relCtch))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqCtchoa-mpaCtchoa,linetype=2)+
      labs(x="Farm attracting power",y="Total catch relative to status quo (kg)")+
      theme_bw()


relAttrOApl<-plot_grid(relAttr_bmOA,relAttr_CtchOA,ncol=1,rel_heights = c(1.15,1))
relAttrOApl


```


```{r relAttrCE}


relAttrCE<-attrCE %>%
    filter(year==max(year)) %>%
    group_by(fAttr)%>%
    summarise(totBm=sum(biomass),
              totCtch=sum(catch))%>%
    mutate(relBM=totBm-sqBMCE,
           relCtch=totCtch-sqCtchCE)%>%
    ungroup()

  ### plots

    relAttr_bmCE<-ggplot(relAttrCE,aes(fAttr,relBM))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqBMCE-mpaBMCE,linetype=2)+
      labs(x="",y="Biomass relative to status quo (kg)",title="Constant Effort")+
      theme_bw()

    relAttr_CtchCE<-ggplot(relAttrCE,aes(fAttr,relCtch))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqCtchCE-mpaCtchCE,linetype=2)+
      labs(x="Farm attracting power",y="Total catch relative to status quo (kg)")+
      theme_bw()


relAttrCEpl<-plot_grid(relAttr_bmCE,relAttr_CtchCE,ncol=1,rel_heights = c(1.15,1))
relAttrCEpl


```

#### Farm stay

*farmStay* decreases the probability of leaving the farm patches to surrounding patches, with a linear multiplier, should have a linear declining affect.

```{r relFunc}


# relPlot<-function(df,fishing,param){
#   
#   sqBM<-if(fishing == "OA"){
#     sqBMoa
#     } else {
#       sqBMCE
#     }
#   
#   sqCh<-if(fishing == "OA"){
#     sqCtchoa
#     } else {
#       sqCtchCE
#     }
#   
#   mpaBM<-if(fishing == "OA"){
#     mpaBMoa
#     } else {
#        mpaBMCE
#     } 
# 
#   mpaCh<-if(fishing == "OA"){
#     mpaCtchoa
#     } else {
#        mpaCtchCE
#       } 
#   
#   tParam <- enquo(param)
#     #tParam <- ensym(param)
# 
#   
#   relDF<-df %>%
#     filter(year==max(year)) %>%
#     group_by(!!tParam)%>%
#     summarise(totBm=sum(biomass),
#               totCtch=sum(catch))%>%
#     mutate(relBM=totBm-sqBM,
#            relCtch=totCtch-sqCh)%>%
#     ungroup()
#   
#   ### plots
# 
#     relPlt_bm<-ggplot(relDF,aes(!!tParam,relBM))+
#       geom_line()+
#       geom_hline(yintercept = 0)+
#       geom_hline(yintercept=sqBM-mpaBM,linetype=2)+
#       labs(x=param,y="Biomass relative to status quo (kg)",title=fishing)+
#       theme_bw()
# 
#     relPlt_Ctch<-ggplot(relDF,aes(!!tParam,relCtch))+
#       geom_line()+
#       geom_hline(yintercept = 0)+
#       geom_hline(yintercept=sqCh-mpaCh,linetype=2)+
#       labs(x=param,y="Total catch relative to status quo (kg)")+
#       theme_bw()
#     
#     
#     relPlt<-plot_grid(relPlt_bm,relPlt_Ctch,ncol=1,rel_heights = c(1.15,1))
#     return(relPlt)
# 
# }
# 
# 
# relPlot(stay2,"OA",param="fStay")
```

```{r relStayOA}


relStayOA<-stay %>%
    filter(year==max(year)) %>%
    group_by(fStay)%>%
    summarise(totBm=sum(biomass),
              totCtch=sum(catch))%>%
    mutate(relBM=totBm-sqBMoa,
           relCtch=totCtch-sqCtchoa)%>%
    ungroup()

  ### plots

    relStay_bmOA<-ggplot(relStayOA,aes(fStay,relBM))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqBMoa-mpaBMoa,linetype=2)+
      labs(x="",y="Biomass relative to status quo (kg)",title="Open Access")+
      theme_bw()

    relStay_CtchOA<-ggplot(relStayOA,aes(fStay,relCtch))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqCtchoa-mpaCtchoa,linetype=2)+
      labs(x="Farm staying power",y="Total catch relative to status quo (kg)")+
      theme_bw()


relStayOApl<-plot_grid(relStay_bmOA,relStay_CtchOA,ncol=1,rel_heights = c(1.15,1))
relStayOApl


```


```{r relStayCE}


relStayCE<-stayCE %>%
    filter(year==max(year)) %>%
    group_by(fStay)%>%
    summarise(totBm=sum(biomass),
              totCtch=sum(catch))%>%
    mutate(relBM=totBm-sqBMCE,
           relCtch=totCtch-sqCtchCE)%>%
    ungroup()

  ### plots

    relStay_bmCE<-ggplot(relStayCE,aes(fStay,relBM))+
      geom_line()+
      geom_hline(yintercept = 0)+
      geom_hline(yintercept=sqBMCE-mpaBMCE,linetype=2)+
      labs(x="",y="Biomass relative to status quo (kg)",title="Constant Effort")+
      theme_bw()

    relStay_CtchCE<-ggplot(relStayCE,aes(fStay,relCtch))+
      geom_line()+
      geom_hline(yintercept = 0)+
      geom_hline(yintercept=sqCtchCE-mpaCtchCE,linetype=2)+
      labs(x="Farm staying power",y="Total catch relative to status quo (kg)")+
      theme_bw()


relStayCEpl<-plot_grid(relStay_bmCE,relStay_CtchCE,ncol=1,rel_heights = c(1.15,1))
relStayCEpl


```

#### Farm size

This is a diffcult one to test since I am assuming so little of the area is protected/farmed (only 10%). So with 100 patches total, that's only 10 patches to divide up into farm space. Might be worth rerunning with finer resolution, to get a better idea of this impact.

```{r relSizeOA}


relSizeOA<-shape %>%
    filter(year==max(year)) %>%
    group_by(farmSize)%>%
    summarise(totBm=sum(biomass),
              totCtch=sum(catch))%>%
    mutate(relBM=totBm-sqBMoa,
           relCtch=totCtch-sqCtchoa)%>%
    ungroup()

  ### plots

    relSize_bmOA<-ggplot(relSizeOA,aes(farmSize,relBM))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqBMoa-mpaBMoa,linetype=2)+
      labs(x="",y="Biomass relative to status quo (kg)",title="Open Access")+
      theme_bw()

    relSize_CtchOA<-ggplot(relSizeOA,aes(farmSize,relCtch))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqCtchoa-mpaCtchoa,linetype=2)+
      labs(x="Size of individual farms",y="Total catch relative to status quo (kg)")+
      theme_bw()


relSizeOApl<-plot_grid(relSize_bmOA,relSize_CtchOA,ncol=1,rel_heights = c(1.15,1))
relSizeOApl


```


```{r relSizeCE}


relSizeCE<-shapeCE %>%
    filter(year==max(year)) %>%
    group_by(farmSize)%>%
    summarise(totBm=sum(biomass),
              totCtch=sum(catch))%>%
    mutate(relBM=totBm-sqBMCE,
           relCtch=totCtch-sqCtchCE)%>%
  filter(farmSize<11)%>%
    ungroup()

  ### plots

    relSize_bmCE<-ggplot(relSizeCE,aes(farmSize,relBM))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqBMCE-mpaBMCE,linetype=2)+
      labs(x="",y="Biomass relative to status quo (kg)",title="Constant Effort")+
      theme_bw()

    relSize_CtchCE<-ggplot(relSizeCE,aes(farmSize,relCtch))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      geom_hline(yintercept=sqCtchCE-mpaCtchCE,linetype=2)+
      labs(x="Size of individual farms",y="Total catch relative to status quo (kg)")+
      theme_bw()


relSizeCEpl<-plot_grid(relSize_bmCE,relSize_CtchCE,ncol=1,rel_heights = c(1.15,1))
relSizeCEpl


```

#### Species movement

Changes in species movement affects both MPA and Farm simulations, unlike above parameters which don't inlfuence MPA impacts at all. 

```{r relMoveOA}


relMoveOA<-move %>%
  filter(year==max(year)) %>%
  group_by(movePar,run)%>%
  summarise(totBm=sum(biomass),
            totCtch=sum(catch))%>%
  mutate(relBM=totBm-sqBMoa,
         relCtch=totCtch-sqCtchoa)%>%
  filter(!run=="noMPA",
         !movePar<2)%>%
  ungroup()

  ### plots

    relMove_bmOA<-ggplot(relMoveOA,aes(movePar,relBM,linetype=run))+
      geom_line()+
      scale_x_continuous(expand=c(0,0))+
      geom_hline(yintercept = 0,color="blue")+
      labs(x="",y="Biomass relative to status quo (kg)",title="Open Access")+
      theme_bw()

    relMove_CtchOA<-ggplot(relMoveOA,aes(movePar,relCtch,linetype=run))+
      geom_line()+
      scale_x_continuous(expand=c(0,0))+
      geom_hline(yintercept = 0,color="blue")+
      labs(x="Species movement",y="Total catch relative to status quo (kg)")+
      theme_bw()


relMoveOApl<-plot_grid(relMove_bmOA,relMove_CtchOA,ncol=1,rel_heights = c(1.15,1))
relMoveOApl


```


```{r relMoveCE}


relMoveCE<-moveCE %>%
    filter(year==max(year)) %>%
    group_by(movePar,run)%>%
    summarise(totBm=sum(biomass),
              totCtch=sum(catch))%>%
    mutate(relBM=totBm-sqBMCE,
           relCtch=totCtch-sqCtchCE)%>%
  filter(!run=="noMPA",
         !movePar<2)%>%
    ungroup()

  ### plots

    relMove_bmCE<-ggplot(relMoveCE,aes(movePar,relBM,linetype=run))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      #geom_hline(yintercept=sqBMCE-mpaBMCE,linetype=2)+
      labs(x="",y="Biomass relative to status quo (kg)",title="Constant Effort")+
      theme_bw()

    relMove_CtchCE<-ggplot(relMoveCE,aes(movePar,relCtch,linetype=run))+
      geom_line()+
      geom_hline(yintercept = 0,color="blue")+
      #geom_hline(yintercept=sqCtchCE-mpaCtchCE,linetype=2)+
      labs(x="Species movement",y="Total catch relative to status quo (kg)")+
      theme_bw()


relMoveCEpl<-plot_grid(relMove_bmCE,relMove_CtchCE,ncol=1,rel_heights = c(1.15,1))
relMoveCEpl


```

## Attraction and size

```{r attrSize}

attrSz<-expand.grid(attraction=seq(1,2,by=0.05),
                    size=seq(1,10,by=1)) %>%
  as_data_frame()%>%
  mutate(biomass=NA,
         catch=NA)

for(i in 195:nrow(attrSz)){

  attrSz[i,3:4]<-sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA,
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 1000,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = as.numeric(attrSz[i,"size"]),
    farmAttr = as.numeric(attrSz[i,"attraction"]),
    buffSize=3) %>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught))%>%
    ungroup()%>%
    filter(year==max(year))%>%
    select(biomass,catch)%>%
    as_vector()

}

attrSz<-attrSz%>%
  mutate(size=replace(size,size==0,10))

ggplot(attrSz,aes(attraction,size,fill=biomass))+
  geom_tile()+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(breaks = c(1,1.25,1.50,1.75,2.0),
                     expand = c(0,0))+
  theme_bw()

```

## Attraction and movement

```{r attrSize}

attrMv<-expand.grid(attraction=seq(1,2,by=0.05),
                    move=seq(1,20,by=1)) %>%
  as_data_frame()%>%
  mutate(biomass=NA,
         catch=NA)

for(i in 1:nrow(attrMv)){

  fishPv$adult_movement<-attrMv[i,2]
  
  attrMv[i,3:4]<-sim_fisheryAq(
    fish = fishPv,
    fleet = fleetOA,
    manager = create_manager(mpa_size = 0.1, year_mpa = 50),
    num_patches = 100,
    sim_years = 100,
    burn_years = 50,
    time_step = fishPv$time_step,
    est_msy = FALSE,
    random_mpas = FALSE,
    min_size = 0.05,
    sprinkler = FALSE,
    keep_burn = FALSE,
    farmSize = 2,
    farmAttr = as.numeric(attrMv[i,"attraction"]),
    buffSize=3) %>%
    group_by(year)%>%
    summarise(biomass=sum(biomass),
              catch=sum(numbers_caught))%>%
    ungroup()%>%
    filter(year==max(year))%>%
    select(biomass,catch)%>%
    as_vector()

}

#return to old movement settings  
fishPv$adult_movement<-2

ggplot(attrMv,aes(attraction,move,fill=biomass))+
  geom_tile()+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(breaks = c(1,1.25,1.50,1.75,2.0),
                     expand = c(0,0))+
  theme_bw()

```

